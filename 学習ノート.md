# Django Tutorialå­¦ç¿’ãƒãƒ¼ãƒˆ

## æº–å‚™

- åŸºæœ¬çš„ã«ã¯[Djangoã®å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://docs.djangoproject.com/ja/2.2/intro/)ã«æ²¿ã£ã¦è¡Œã†
- å®Ÿè¡Œç’°å¢ƒã¯Dockerä¸Šã«ä½œæˆã™ã‚‹
  - appã®ãƒãƒ¼ãƒˆã¯éƒ½åˆã«ã‚ˆã‚Š7000ç•ªã‚’ä½¿ã†
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã«ã¯Pipenvã‚’ä½¿ç”¨ã™ã‚‹
  - ãã®ãŸã‚[ã“ã“ã®Dockerfile](http://docs.docker.jp/compose/django.html)ã¯ä½¿ç”¨ã—ãªã„
- editorconfigã¯[cookiecutter-django](https://qiita.com/ping2shi2/items/e3366bf9600bddeede07)ã‹ã‚‰æµç”¨
- DBã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«åˆã‚ã›ã¦Postgresqlã‚’é¸æŠã™ã‚‹
- é–‹å§‹æ™‚ã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯`~/workspace/try_django/`ã¨ã™ã‚‹

## Djangoã®æ¦‚è¦

ã„ããªã‚Šèª­ã‚“ã§ã‚‚æ„å‘³ãŒåˆ†ã‹ã‚‰ãªãã†ãªã®ã§ã™ã£é£›ã°ã™ã€‚

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰

ã“ã‚Œã‚‚çœç•¥ã€‚Dockerfileï¼‹docker-compose.ymlï¼‹Pipfileã§ã‚„ã‚‹ã€‚

```sh
docker-compose build
docker-compose run app pipenv install
```

## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®1

> Django ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹[...]ã‚’èª¿ã¹ã‚‹ã«ã¯[...]

Dockerä¸Šã§é–‹ç™ºã‚’é€²ã‚ã‚‹ã®ã§ã€ä½¿ç”¨ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`docker-compose exec app ...`å½¢å¼ã«èª­ã¿æ›¿ãˆã‚‹ã€‚

```sh
python -m django --version
```

â†“

```sh
docker-compose exec app pipenv run python -m django --version
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹

> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šã‚„Djangoå›ºæœ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®è¨­å®šãªã©ã¨ã„ã£ãŸã€
> å€‹ã€…ã®Djangoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®è¨­å®šã‚’é›†ã‚ãŸã‚‚ã®ã§ã™ã€‚

ã¾ã å§‹ã‚ã¦ã‚‚ã„ãªã„ã®ã«ãã‚“ãªã“ã¨ã‚’è¨€ã‚ã‚Œã¦ã‚‚æ„å‘³ä¸æ˜ãªã®ã§ã‚¹ãƒ«ãƒ¼ã€‚

> ã‚³ãƒ¼ãƒ‰ã‚’ç½®ããŸã„å ´æ‰€ã«cdã—ã¦ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚  
> `django-admin startproject mysite`

workspace/try_djangoã§[startproject](https://docs.djangoproject.com/ja/2.2/ref/django-admin/#django-admin-startproject)ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚

```sh
docker-compose run app pipenv run django-admin startproject mysite
```

ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«manage.pyã¨mysiteãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä½œã‚‰ã‚ŒãŸã€‚  
ã“ã‚Œã¯[GitHubã®djangoãƒªãƒã‚¸ãƒˆãƒª](https://github.com/django/django/tree/stable/2.2.x/django/conf/project_template)ãŒã²ãªå½¢ã«ãªã£ã¦ã„ã‚‹æ¨¡æ§˜ã€‚

```
try_django/        â†ã€Œãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€
â”œâ”€.gitignore           â”
â”œâ”€docker-compose.yml   â”‚
â”œâ”€Dockerfile           â”‚
â”œâ”€Pipfile              â”œâ”€æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€Pipfile.lock         â”‚
â”œâ”€README.md            â”‚
â”œâ”€å­¦ç¿’ãƒãƒ¼ãƒˆ.md         â”‚
â”œâ”€.venv/               â”˜
â”œâ”€db.sqlite3         â†DBè¨­å®šã¯ã€Œmysite\settings.pyã€ã«è¨˜è¼‰ã‚ã‚Š
â”œâ”€manage.py         â†ã€Œç®¡ç†è€…æ¨©é™ã®å‡¦ç†ã‚’è¡Œã†ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã€
â””â”€mysite/
    â”œâ”€__init__.py         â†åŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹settingsã‚„urlsã‚’ä»–ã®ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰importã—ã¦ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
    â”œâ”€settings.py         â†ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€urls.py
    â””â”€wsgi.py         â†ã€ŒWeb Server Gateway Interfaceã€ï¼ˆWebã‚¢ãƒ—ãƒªãƒ»ã‚µãƒ¼ãƒé–“ã®IFå®šç¾©ï¼‰ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ğŸ‡
```

### é–‹ç™ºç”¨ã‚µãƒ¼ãƒãƒ¼

> ã“ã®ã‚µãƒ¼ãƒã¯é–‹ç™ºä¸­ã®åˆ©ç”¨ã ã‘ã‚’è€ƒãˆã¦ä½œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚çµ¶å¯¾ã«é‹ç”¨ç’°å¢ƒã§ã¯ä½¿ã‚ãªã„ã§ãã ã•ã„(ç­†è€…ãŸã¡ã®å°‚é–€ã¯Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã£ã¦ã€Webã‚µãƒ¼ãƒã§ã¯ã‚ã‚Šã¾ã›ã‚“)ã€‚

Pipfileã¨docker-compose.ymlã§è¨­å®šæ¸ˆã¿ãªã®ã§ã€`docker-compose up`ã€`open localhost:7000`ã€‚  
ğŸš€ãŒå‡ºã¦ããŸã®ã§æˆåŠŸã€‚èµ·å‹•ãƒ­ã‚°ã¯ã‹ãªã‚Šè¦ªåˆ‡ã£ã½ã„ï¼ˆèª­ã‚“ã§ãªã„ã‘ã©ï¼‰ã€‚

```
app_1  | Watching for file changes with StatReloader
app_1  | Performing system checks...
app_1  |
app_1  | System check identified no issues (0 silenced).
app_1  |
app_1  | You have 17 unapplied migration(s). Your project may not work properly until you apply the migrations for app(s):
admin, auth, contenttypes, sessions.
app_1  | Run 'python manage.py migrate' to apply them.
app_1  | August 10, 2019 - 07:17:23
app_1  | Django version 2.2.4, using settings 'mysite.settings'
app_1  | Starting development server at http://0.0.0.0:7000/
app_1  | Quit the server with CONTROL-C.
```

### Pollsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã¤ãã‚‹

> ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ã€å®Ÿéš›ã«ä½•ã‚‰ã‹ã®å‡¦ç†ã‚’è¡Œã†Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒ‡ã—ã¾ã™ã€‚
> ä¾‹ãˆã°ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚„å…¬é–‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€å˜ç´”ãªæŠ•ç¥¨ã‚¢ãƒ—ãƒªã¨ã„ã£ãŸå…·åˆã§ã™ã€‚
> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã¯ã€ã‚ã‚‹ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆå‘ã‘ã«è¨­å®šã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é›†ã‚ãŸã‚‚ã®ã§ã™ã€‚
> ä¸€ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¥ã‚Œã‚‰ã‚Œã¾ã™ã€‚
> ã¾ãŸã€ä¸€ã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯è¤‡æ•°ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ãˆã¾ã™ã€‚

```sh
docker-compose exec app pipenv run python manage.py startapp polls
```

polls/ä»¥ä¸‹ã«views.pyã¨models.pyã¨tests.pyãŒä½œæˆã•ã‚Œã‚‹ã€‚routeã‚‰ã—ãã‚‚ã®ã¯ç„¡ã„ã€‚

```
polls/
    __init__.py
    admin.py
    apps.py
    migrations/
        __init__.py
    models.py
    tests.py
    views.py
```

#### è„±ç·š

ã“ã“ã§ã„ããªã‚Šlocalhost/pollsã«é£›ã¶ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã€‚pollsã‚¢ãƒ—ãƒªã¯ä½œã£ãŸã‘ã©ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„çŠ¶æ…‹ã€‚

```
Using the URLconf defined in mysite.urls, Django tried these URL patterns, in this order:
admin/
```

URLconfã¨ã¯ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æƒ…å ±ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹`urls.py`ãƒ•ã‚¡ã‚¤ãƒ«ã®ã“ã¨ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã«ã‚‚ã€å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚ã€ãã‚Œãã‚Œç‹¬è‡ªã®urls.pyãŒå­˜åœ¨ã™ã‚‹ï¼ˆã‚¢ãƒ—ãƒªå˜ä½ã®ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œãªã„ã®ã§è¦ä½œæˆï¼‰ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®urls.pyãŒå„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®urls.pyã‚’å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒè§£æ±ºã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ç¾çŠ¶ã§ã¯ã€è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ`mysite\urls.py`ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã®urls.pyï¼‰ã—ã‹ãªã„ã®ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã€‚

`mysite\urls.py`
```py
urlpatterns = [
    path('admin/', admin.site.urls),
]
```

pathé–¢æ•°ã¯ã€`path(<URL>, <VIEW>)`ã€‚ãƒ¦ãƒ¼ã‚¶ã®æŒ‡å®šã—ãŸURLãŒã©ã‚Œã‹ã®pathã®ç¬¬1å¼•æ•°ã«ä¸€è‡´ã—ãŸã‚‰ãã“ã§ç”»é¢é·ç§»ã€‚

`polls\urls.py`ã¯å­˜åœ¨ã—ãªã„ã€‚

### ã¯ã˜ã‚ã¦ã®ãƒ“ãƒ¥ãƒ¼ä½œæˆ

localhost/pollsã«é£›ã¹ãªã‹ã£ãŸã®ã§ã€ãƒ“ãƒ¥ãƒ¼ã‚’ã™ã£é£›ã°ã—ã¦å…ˆã«urls.pyå‘¨ã‚Šã‚’è¦‹ã¦ã¿ã‚‹ã€‚

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«å€£ã£ã¦ã€`polls\urls.py`ã‚’ä½œæˆã—ã€`mysite\urls.py`ã«pollså‘ã‘ã®pathã‚’å®šç¾©ã€‚

`polls/urls.py`
```py
urlpatterns = [
    path('', views.index, name='index'),
]
```

indexã¨ã„ã†åå‰ã®ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ«ãƒ¼ãƒˆURLã«å‰²ã‚Šå½“ã¦ã€ãã®åå‰ã‚’indexã¨ã—ã¦ã„ã‚‹ã€‚

`mysite\urls.py`
```py
urlpatterns = [
    path('polls/', include('polls.urls')),
    path('admin/', admin.site.urls),
]
```

ãƒ¦ãƒ¼ã‚¶ãŒå…¥åŠ›ã—ãŸURLãŒ'polls/'ã ã£ãŸã‚‰ã€å¾Œç¶šå‡¦ç†ã¯`polls/urls.py`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»»ã›ã‚‹ä»•çµ„ã¿ã€‚

> DjangoãŒinclude()ã«é­é‡ã™ã‚‹ã¨ã€ãã®ãƒã‚¤ãƒ³ãƒˆã¾ã§ã«ä¸€è‡´ã—ãŸURLã®éƒ¨åˆ†ã‚’åˆ‡ã‚Šè½ã¨ã—ã€
> æ¬¡ã®å‡¦ç†ã®ãŸã‚ã«æ®‹ã‚Šã®æ–‡å­—åˆ—ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã•ã‚ŒãŸURLconfã¸æ¸¡ã—ã¾ã™ã€‚

ã“ã“ã¾ã§ä¿®æ­£ã—ãŸã‚‰ã€ãƒ«ãƒ¼ãƒˆã‹ã‚‰é£›ã¹ãŸCongratulations!ç”»é¢ã«è¡Œã‘ãªããªã£ãŸã€‚ã¾ã‚ãã‚“ãªã‚‚ã‚“ã‹ã€‚ã€‚ã€‚

ã“ã“ã§`localhost/polls`ã«ã‚¢ã‚¯ã‚»ã‚¹ã€‚urls.pyçš„ã«ã¯pollsã‚¢ãƒ—ãƒªã®indexãƒ“ãƒ¥ãƒ¼ã«é£›ã¶ã¯ãšã€‚  
â†’ã‚¨ãƒ©ãƒ¼`AttributeError: module 'polls.views' has no attribute 'index'`ã€‚

ã¾ã ä½•ã‚‚ãªã„çŠ¶æ…‹ã‚‰ã—ã„ã®ã§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«æˆ»ã£ã¦å®Ÿè£…ã€‚

#### é–‘è©±ä¼‘é¡Œ

indexã«ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã£ãŸã‚‰ã€ãã‚Œã«å¯¾å¿œã™ã‚‹HttpResponseã‚’è¿”ã™ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã€‚  
ãã®ãŸã‚ã«ã„ã˜ã‚‹ã®ãŒ`views.py`ã€‚ã“ã“ã«`return HttpResponse(str)`ã¨ã‹`render(str)`ã¨ã‹ã‚’æ›¸ãã€‚  
ï¼ˆã“ã‚Œã€Œãƒ“ãƒ¥ãƒ¼ã€ã£ã¦ã„ã†ã®ï¼Ÿï¼‰

ã¡ãªã¿ã«views.pyã«ä½•ã‚‚ã—ãªã„

```py
def index(request):
    pass
```

ã‚’ä½œã‚‹ã¨HttpResponseã‚’è¿”ã—ã¦ã„ãªã„ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã€‚`ValueError: The view polls.views.index didn't return an HttpResponse object.[...]`

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«é€šã‚Šã«ã“ã†ã™ã‚‹ã€‚

`polls/views.py`
```py
from django.http import HttpResponse
def index(request):
    return HttpResponse("Hello, world. You're at the polls index.")
```

é£›ã¹ãŸï¼

å…ˆã«ã€Œurls.pyã«ç„¡ã‹ã£ãŸã‚‰é£›ã¹ãªã„ã€ã“ã¨ã¯ç¢ºèªã§ããŸã®ã§ã€å¤šã‹ã£ãŸã‚‰é£›ã¹ã‚‹ï¼Ÿã‚’è¦‹ã¦ã¿ã‚‹ã€‚

`mysite\urls.py`
```py
urlpatterns = [
    path('polls/', include('polls.urls')),
    path('polls/', admin.site.urls),
    path('admin/', admin.site.urls),
]
```

ã¨ã—ã¦ã‚‚å•é¡Œãªã`include('polls.urls')`ã«è¡Œã‘ãŸã€‚URLã®ãƒãƒƒãƒãƒ³ã‚°ã¯ã€Œä¸Šã‹ã‚‰è¦‹ã¦è¡Œã£ã¦è¦‹ã¤ã‹ã£ãŸå ´æ‰€ã«é£›ã¶ã€ã‚‰ã—ã„ã€‚

#### ãƒ“ãƒ¥ãƒ¼ï¼Ÿ

FAQã«ã‚ˆã‚‹ã¨
> [Django ã¯ MVC ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚ˆã†ã«æ€ãˆã‚‹ã®ã§ã™ãŒã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© (Controller) ã‚’ã€Œãƒ“ãƒ¥ãƒ¼ (view)ã€ã¨å‘¼ã³ã€ãƒ“ãƒ¥ãƒ¼ (View) ã‚’ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (template)ã€ã¨å‘¼ã‚“ã§ã„ã¾ã™ã€‚ãªãœæ¨™æº–çš„ãªå‘¼ã³æ–¹ã‚’ã—ãªã„ã®ã§ã™ã‹ï¼Ÿ](https://docs.djangoproject.com/ja/2.2/faq/general/#django-appears-to-be-a-mvc-framework-but-you-call-the-controller-the-view-and-the-view-the-template-how-come-you-don-t-use-the-standard-names)
> 
> Djangoã®MVCã®è§£é‡ˆã§ã¯ã€ã€Œãƒ“ãƒ¥ãƒ¼ã€ã¯[...]*ãƒ¦ãƒ¼ã‚¶ãŒè¦‹ã‚‹ã®ã¯ã©ã®ãƒ‡ãƒ¼ã‚¿ãªã®ã‹*ã‚’æ›¸ãã®ã§ã‚ã£ã¦ã€*ãƒ¦ãƒ¼ã‚¶ã«å¯¾ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã®ä»•æ–¹*ã‚’æ›¸ãã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
> 
> ã§ã¯ã€ã€Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€ã¯ã©ã“ã«å…¥ã‚‹ã®ã§ã—ã‚‡ã†ã‹ã€‚ Django ã®å ´åˆã€ãŠãã‚‰ããƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€ã™ãªã‚ã¡ URL è¨­å®šã«ã—ãŸãŒã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é©åˆ‡ãªãƒ“ãƒ¥ãƒ¼ã«é€ä¿¡ã™ã‚‹æ©Ÿæ§‹è‡ªä½“ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã«ã‚ãŸã‚‹ã¨ã„ãˆã‚‹ã§ã—ã‚‡ã†ã€‚
> 
> Djangoã‚’â€œMTVâ€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨å‘¼ã‚“ã§ã‚‚ã‚ˆã„ã§ã—ã‚‡ã†ã€‚ã¤ã¾ã‚Šã€ŒModelã€Templateã€Viewã€ã§ã™ã€‚


## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®2

> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã€æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã€ãã—ã¦ Django ãŒè‡ªå‹•çš„ã«ç”Ÿæˆã—ã¦ãã‚Œã‚‹ç®¡ç† (admin) ã‚µã‚¤ãƒˆã«ã¤ã„ã¦ã€ç°¡å˜ãªã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã—ã¾ã™ã€‚

### Databaseã®è¨­å®š

è¨­å®šã¯`mysite/settings.py`ã«è¨˜è¼‰ã—ã€migrateã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã€‚  
ï¼ˆmigrateã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã€Œæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã€ã«é–¢é€£ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã€‚ï¼‰  
ï¼ˆãŸã ã—ã€migrationã§ã¯create databaseã¯ã—ã¦ãã‚Œãªã„æ¨¡æ§˜ã€‚ï¼‰

```sh
python manage.py migrate
```

æœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã¯ä»¥ä¸‹ã®ã‚‚ã®

`mysite\settings.py`
```py
INSTALLED_APPS = [
    'django.contrib.admin',          # ç®¡ç†ï¼ˆadminï¼‰ã‚µã‚¤ãƒˆ
    'django.contrib.auth',          # èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
    'django.contrib.contenttypes',          # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    'django.contrib.sessions',          # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    'django.contrib.messages',          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    'django.contrib.staticfiles',          # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
]
```

ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä»¥ä¸‹

```sh
$ docker-compose run app pipenv run python manage.py dbshell

mydatabase=# \dt
                   List of relations
 Schema |            Name            | Type  |  Owner
--------+----------------------------+-------+----------
 public | auth_group                 | table | postgres
 public | auth_group_permissions     | table | postgres
 public | auth_permission            | table | postgres
 public | auth_user                  | table | postgres
 public | auth_user_groups           | table | postgres
 public | auth_user_user_permissions | table | postgres
 public | django_admin_log           | table | postgres
 public | django_content_type        | table | postgres
 public | django_migrations          | table | postgres
 public | django_session             | table | postgres
(10 rows)
```

### ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ

ã‚¢ãƒ—ãƒªã”ã¨ã®`models.py`ã«ã€è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã€‚

ã¾ãŸã€Choiceã‚¯ãƒ©ã‚¹ã®questionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ã„ã‚ã‚†ã‚‹ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚‚ã“ã“ã§å®šç¾©ã§ãã‚‹ã€‚
ã“ã“ã§ã¯Choice#questionã¨Question#idãŒ1:1ã§å¯¾å¿œã™ã‚‹ã€‚

### ãƒ¢ãƒ‡ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹

ãƒ†ãƒ¼ãƒ–ãƒ«åã¯<ã‚¢ãƒ—ãƒªå>\_<ãƒ¢ãƒ‡ãƒ«å>
ä¸»ã‚­ãƒ¼ã¯idï¼ˆé€£ç•ªï¼‰ã€‚ä»–ã«è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ãªã„ï¼ˆcreated_atã¨ã‹ï¼‰
åŸºæœ¬çš„ã«not nullã€‚
makemigrationsã‚’ã—ãªã„ã¨migrateã§åæ˜ ã•ã‚Œãªã„ã€‚
ãŸã ã—ã€makemigrationsã‚’å¿˜ã‚Œã¦migrateã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒ¢ãƒ‡ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸæ—¨ã‚’çŸ¥ã‚‰ã›ã‚‹WARNINGãŒå‡ºã‚‹ã€‚

### APIã§éŠã‚“ã§ã¿ã‚‹

> å˜ãªã‚‹"python"ã‚³ãƒãƒ³ãƒ‰ã§ã¯ãªã"python manage.py shell"ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€
> manage.pyãŒDJANGO_SETTINGS_MODULEç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã‚Œã‚‹ã€‚
> ã“ã‚Œã«ã‚ˆã‚Šã€Djangoã«mysite/settings.pyãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®importãƒ‘ã‚¹ãŒä¸ãˆã‚‰ã‚Œã‚‹ã€‚

python manage.py shellã®ä¸­ã§ã€å„ã‚¢ãƒ—ãƒªã¯importã—ãªã„ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã®ã§æ³¨æ„

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã¡ã‚‡ã£ã¨é¢ç™½ã„ã€‚  
`Question.objects.get(pub_date__year=2019)`  
`<field>__<lookuptype>=<value>`å½¢å¼ã€‚fieldã¨lookuptypeã®é–“ã«å…¥ã‚‹ã®ã¯ãƒ€ãƒ–ãƒ«ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã€‚

### Django Adminã®ç´¹ä»‹

> Djangoã¯ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ ç’°å¢ƒã§é–‹ç™ºã•ã‚Œã¾ã—ãŸã€‚
> ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ ç’°å¢ƒã§ã¯ã€ã€Œã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆè€…ã€ã¨ã€Œå…¬é–‹ã€ã‚µã‚¤ãƒˆã‚’ãã‚ã‚ã¦æ˜ç¢ºã«åŒºåˆ¥ã—ã¦ã„ã¾ã™ã€‚
> Djangoã¯ã€ã‚µã‚¤ãƒˆç®¡ç†è€…å‘ã‘ã®ä¸€å…ƒåŒ–ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
> adminã¯ã‚µã‚¤ãƒˆã®è¨ªå•è€…ã§ãªãã€ã‚µã‚¤ãƒˆç®¡ç†è€…ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã¾ã™ã€‚

```sh
python manage.py createsuperuser
```

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã€Œpasswordã€ã¨ã—ãŸã‚‰ã¡ã‚‡ã£ã¨æ€’ã‚‰ã‚ŒãŸã€‚

> This password is too common.
> Bypass password validation and create user anyway?

ã‚¢ãƒ—ãƒªã”ã¨ã«ç®¡ç†ã§ãã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®šã§ãã‚‹ï¼ˆå„ã‚¢ãƒ—ãƒªå†…ã§æŒ‡å®šï¼‰ã€‚  
datetimeå‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯datepickerã¨timepickerãŒã¤ã„ã¦ãŸã€‚  
settings.pyã§LANGUAGE_CODE = 'ja'ã«ã—ãŸã‚‰æ—¥æœ¬èªåŒ–ã•ã‚ŒãŸã€‚  
TIME_ZONE = 'Asia/Tokyo'ã«ã—ãŸã‚‰Polls > Questionsã®pub_dateãŒã•ã£ãã®æ™‚é–“ã«ãªã£ãŸ  
ã“ã“ã§å¤‰æ›´ã—ãŸã‚‰ã€ãã®å¤‰æ›´å±¥æ­´ã‚‚è¦‹ã‚Œã‚‹ã€‚

## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®3

### ã‚ªãƒ¼ãƒãƒ¼ãƒ“ãƒ¥ãƒ¼

> ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³ã‚’ã—ã¦ã‚‹ã¨ããªã©ã«ã€"ME2/Sites/dirmod.asp?sid=&type=gen&mod=Core+Pages&gid=A6CD4967199A42D9B65B1B"ã®ã‚ˆã†ãªãªã‚“ã¨ã‚‚ç´ æ™´ã‚‰ã—ã„URLã‚’è¦‹ã‹ã‘ã‚‹ã“ã¨ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚Djangoã¯ã“ã‚“ãªã‚‚ã®ã‚ˆã‚Šã‚‚ã£ã¨ã‚¨ãƒ¬ã‚¬ãƒ³ãƒˆãª"URLãƒ‘ã‚¿ãƒ¼ãƒ³"ã‚’æä¾›ã—ã¦ã„ã‚‹ã¨çŸ¥ã£ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ASP.NETãƒ‡ã‚£ã‚¹ã‚‰ã‚ŒãŸã€‚

### ã‚‚ã£ã¨ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã‚‹

modelã¨åŒæ§˜ã«ã€viewã‚‚ã‚¢ãƒ—ãƒªã”ã¨ã®views.pyã«ãã®åˆ†ã®ã‚¯ãƒ©ã‚¹ã‚’æ›¸ã„ã¦ã„ãå½¢å¼ã€‚  
ã¾ãŸã€viewã‚’è¿½åŠ ã—ãŸã‚‰ãã®åˆ†ã®path()å‘¼ã³å‡ºã—ã‚’polls.urlsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«è¨˜è¿°ã™ã‚‹ã€‚

ä¾‹ãˆã°ä»¥ä¸‹ã‚’polls\urls.pyã«å®šç¾©ã—ãŸçŠ¶æ…‹ã§ã€`/polls/hello`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€404ã‚¨ãƒ©ãƒ¼ã€‚  
`path('<int:question_id>/results/', views.results, name='results'),`  
ã“ã‚Œã¯ã€`polls/<int>/results/`ã¯å®šç¾©æ¸ˆã¿ã ãŒ`polls/<str>/results/`ã¯ã€æœªå®šç¾©ã®ãŸã‚ã€‚

> .htmlã®ã‚ˆã†ãªæ–‡å­—åˆ—ã‚’URLã«è¿½åŠ ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã—ã€æ¬¡ã®ã‚ˆã†ã«ã™ã‚Œã°ã€è¡¨ç¾ã§ãã¾ã™:  
> path('polls/latest.html', views.index),  
> ã¨ã¯ã„ãˆã€ã“ã‚“ãªé˜¿å‘†ãªã“ã¨ã¯ã‚„ã‚ã¾ã—ã‚‡ã†ã€‚

ã¯ãƒ

### å®Ÿéš›ã«å‹•ä½œã™ã‚‹ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã

> ãƒ“ãƒ¥ãƒ¼ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã ã—ã¦ã‚‚ã€èª­ã¿å‡ºã•ãªãã¦ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ã€‚
> Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã€[...]ã‚’ä½¿ã£ã¦ã‚‚ã‚ˆã„ã§ã™ã—ã€ä½¿ã‚ãªãã¦ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ã€‚
> PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ã‚‚ã€XMLã‚’å‡ºåŠ›ã—ã¦ã‚‚ã€ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®å ´ã§ç”Ÿæˆã—ã¦ã‚‚ã‹ã¾ã„ã¾ã›ã‚“ã€‚
> Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ã‚„ã‚ŠãŸã„ã“ã¨ã‚’ä½•ã§ã‚‚å®Ÿç¾ã§ãã¾ã™ã€‚

ãƒ“ãƒ¥ãƒ¼ã£ã¦è¨€ã‚ã‚Œã‚‹ã¨æ··ä¹±ã™ã‚‹ã€‚

> è©¦ã—ã«æ¬¡ã®ã‚ˆã†ãªindex()ãƒ“ãƒ¥ãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚[...]
> ã“ã®ã‚³ãƒ¼ãƒ‰ã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ“ãƒ¥ãƒ¼ã®ä¸­ã§ã€ãƒšãƒ¼ã‚¸ã®ãƒ‡ã‚¶ã‚¤ãƒ³ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
> ãƒšãƒ¼ã‚¸ã®è¦‹æ „ãˆã‚’å¤‰æ›´ã™ã‚‹ãŸã³ã«ã€Pythonã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã£ã¦ã€ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ä½¿ç”¨ã§ãã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã—ã€Pythonã‹ã‚‰ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’åˆ†é›¢ã—ã¾ã—ã‚‡ã†ã€‚

ãƒ“ãƒ¥ãƒ¼ã£ã¦è¨€ã‚ã‚Œã‚‹ã¨æ··ä¹±ã™ã‚‹ã€‚

> è¦å®šï¼ˆmysite\settings.pyã«æ›¸ã‹ã‚ŒãŸ`TEMPLATES.APP_DIRS': True`ï¼‰ã«ã‚ˆã‚Šã€
> DjangoTemplatesã¯INSTALLED_APPSã®ãã‚Œãã‚Œã®"templates"ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æ¤œç´¢ã—ã¾ã™ã€‚
> ï¼ˆpollsã‚¢ãƒ—ãƒªã§ä½¿ã†ï¼‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯polls/templates/polls/index.htmlã«æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> ï¼ˆãã†ã™ã‚‹ã¨ã€ï¼‰Djangoå†…ã§ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å˜ã«polls/index.htmlã®ã‚ˆã†ã«å‚ç…§ã§ãã¾ã™ã€‚

ã“ã“ã§è¨€ã†INSTALLED_APPSã¯ã€settings.pyã®INSTALLED_APPSã«æŒ‡å®šã•ã‚ŒãŸã€Œã™ã¹ã¦ã€ã‚’è¨€ã†ã€‚  
ã¤ã¾ã‚Šã€DjangoãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¢ã™ã¨ãã«ã¯ã©ã®ã‚¢ãƒ—ãƒªé…ä¸‹ã«ã‚ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã®ã‹ã‚’åŒºåˆ¥ã—ãªã„ã€‚  
ãªã®ã§å†—é•·ã ãŒ`polls/templates/polls/index.html`ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã«ã—ã¦`index.html`ã§ã¯ãªã`polls/index.html`ã‚’æ¢ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã¨ã„ã†ã‹ã“ã“ã§ã‚ˆã†ã‚„ãRailsã®scaffoldã§æ°—æ¥½ã«ä½œã‚Œã‚‹ç”»é¢ã‚’ä½œã‚Œã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¦ããŸã€‚

### ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: render()

> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å€¤ã‚’å…¥ã‚Œã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸçµæœã‚’HttpResponseã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§è¿”ã™ã€ã¨ã„ã†ã‚¤ãƒ‡ã‚£ã‚ªãƒ 

#### å†—é•·

```py
def index(request):
    # loaderã¨HttpResponseã‚’import
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    template = loader.get_template('polls/index.html')
    context = {'latest_question_list': latest_question_list}
    return HttpResponse(template.render(context, request))
```

#### ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

```py
def index(request):
    # renderã‚’import
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    context = {'latest_question_list': latest_question_list}
    return render(request, 'polls/index.html', context)
```

### 404ã‚¨ãƒ©ãƒ¼ã®é€å‡º

> ã“ã®ãƒ“ãƒ¥ãƒ¼ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸIDã‚’æŒã¤è³ªå•ãŒå­˜åœ¨ã—ãªã„ã¨ãã«Http404ã‚’é€å‡ºã—ã¾ã™ã€‚

mysite\settings.pyã‚’ä¿®æ­£ã™ã‚Œã°404ã‚¨ãƒ©ãƒ¼ã‚’è¦‹ã‚Œã‚‹çŠ¶æ…‹ã«ãªã‚‹ã€‚

```py
DEBUG = False # Trueã‚ˆã‚Šå¤‰æ›´

ALLOWED_HOSTS = ['localhost'] # []ã‚ˆã‚Šå¤‰æ›´
```

ã¡ãªã¿ã«Djangoãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®404ã‚¨ãƒ©ãƒ¼ç”»é¢ã®ã‚½ãƒ¼ã‚¹å…¨æ–‡ã¯ã“ã‚Œã€‚ã‚·ãƒ³ãƒ—ãƒ«ã€‚

```
<h1>Not Found</h1>
<p>The requested resource was not found on this server.</p>
```

ã¡ãªã¿ã«ã¡ãªã¿ã«ã€[å°‘ã—å‰](https://github.com/django/django/commit/64d2396e83aedba3fcc84ca40f23fbd22f0b9b5b)ã¾ã§ã¯

```
<h1>Not Found</h1>
<p>The requested URL {{ request_path }} was not found on this server.</p>
```

ã§ã€ã—ã‹ã‚‚request_pathã¯å…¥åŠ›å†…å®¹ãã®ã¾ã¾ã ã£ãŸ[ã‚‰ã—ã„](https://medium.com/creditengine-tech/djangoã®è„†å¼±æ€§cve-2019-3498ã«ã¤ã„ã¦è§£èª¬-c87d50f3ac55)ã€‚

404ãƒšãƒ¼ã‚¸ã‚’å¤‰ãˆãŸã„å ´åˆã¯ã€ä»»æ„ã®templateãƒ•ã‚©ãƒ«ãƒ€ã«404.htmlã‚’ç½®ã‘ã°ã„ã„ã€‚
<https://torina.top/detail/262/>

ã¤ã„ã§ã«ALLOWED_HOSTSãƒã‚¿2ã¤ã€‚

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«ã¤ã„ã¦ã¯[Djangoã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](https://docs.djangoproject.com/ja/2.2/topics/security/)ã«ã¾ã¨ã¾ã£ã¦ã„ã‚‹ã€‚
- ã€ŒEC2 IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’Djangoã«å‹•çš„ã«è¿½åŠ ã™ã‚‹æ–¹æ³•ã€ã¨ã„ã†æ‚²ã—ã„é‹ç”¨ã«é–¢ã™ã‚‹è³ªç–‘å¿œç­”ãŒ[ã“ã“](https://docs.djangoproject.com/ja/2.2/topics/security/)ã«ã‚ã£ãŸã€‚

> polls/detail.htmlãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«
> {{ question }}ã¨æ›¸ã„ã¦ãŠã„ã¦ãã ã•ã„ã€‚

`question`ã¯`views.detail`ã‹ã‚‰`detail.html`ã«é€ã‚‰ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚  
`{{ question }}`ã«ã‚ˆã£ã¦index.htmlã®`{{ question.question_text }}`ã¨åŒã˜ã€ŒWhat's up?ã€ãŒè¡¨ç¤ºã•ã‚ŒãŸã€‚  
ã£ã¦ã“ã¨ã¯`{{ question }}`ã®æ­£ä½“ã¯`question.__str__()`ã€‚

### ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: get_object_or_404()

> get()ã‚’å®Ÿè¡Œã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã«ã¯Http404ã‚’é€å‡ºã™ã‚‹[...]ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒã‚ã‚‹ã®ã ã‹ã‚‰ã‚ã–ã‚ã–ã“ã®å ´åˆã«tryï½exceptã¯ä½¿ã†ãªã¨ã€‚

- [Djangoã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé–¢æ•°](https://docs.djangoproject.com/ja/2.2/topics/http/shortcuts/#module-django.shortcuts)

  > django.shortcutsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ã€MVCã®è¤‡æ•°ã®ãƒ¬ãƒ™ãƒ«ã«ã¾ãŸãŒã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¨ã‚¯ãƒ©ã‚¹ã‚’é›†ã‚ãŸã‚‚ã®ã§ã™ã€‚
  > è¨€ã„æ›ãˆã‚Œã°ã€ã“ã‚Œã‚‰ã®é–¢æ•°ã‚„ã‚¯ãƒ©ã‚¹ã¯ã€ä¾¿å®œä¸Šã€æ§ãˆã‚ãªçµåˆã‚’å–ã‚Šå…¥ã‚Œã¾ã™ã€‚

- [Djangoã®è¨­è¨ˆæ€æƒ³](https://djangoproject.jp/doc/ja/1.0/misc/design-philosophies.html)
  > ãƒ«ãƒ¼ã‚¹ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°
  > ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ§˜ã€…ãªãƒ¬ã‚¤ãƒ¤ã¯ã€æœ¬å½“ã«å¿…è¦ãªå ´åˆã‚’é™¤ãã€ãŠäº’ã„ã®äº‹æƒ…ã‚’çŸ¥ã‚‰ãªãã¦ã‚‚ã‚ˆã„ã¨ã„ã†è€ƒãˆæ–¹ã§ã™ã€‚
  > ä¾‹ãˆã°ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¯Webãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã©ã®ã‚ˆã†ãªã‚‚ã®ã‹é–¢çŸ¥ã›ãšã€[...]
  > åˆ©ä¾¿æ€§ã®ãŸã‚ã€Djangoã«ã¯å…¨ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ãŒã¤ã„ã¦ãã¾ã™ãŒã€ã‚¹ã‚¿ãƒƒã‚¯ã®å„éƒ¨åˆ†ã¯å¯èƒ½ãªé™ã‚Šäº’ã„ã«ç‹¬ç«‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ã†

```
{% for choice in question.choice_set.all %}
    <li>{{ choice.choice_text }}</li>
{% endfor %}
```

ã¨ã“ã‚ã§choice_setã£ã¦ä½•è€…ï¼Ÿ

https://docs.djangoproject.com/ja/2.2/topics/db/queries/#following-relationships-backward

> ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—"åå¯¾å‘ãâ€ã‚’ç†è§£ã™ã‚‹
> ãƒ¢ãƒ‡ãƒ«ãŒForeignKeyã‚’æŒã¤å ´åˆã€å¤–éƒ¨ã‚­ãƒ¼ã®ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿”ã™Managerã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
> ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã“ã®Managerã¯FOO_setã¨åä»˜ã‘ã‚‰ã‚Œã¦ãŠã‚Šã€FOOã«ã¯å…ƒã®ãƒ¢ãƒ‡ãƒ«åãŒå°æ–‡å­—ã§å…¥ã‚Šã¾ã™ã€‚

è¦ã¯ã€é–‹ç™ºè€…ãŒãƒ¢ãƒ‡ãƒ«ä¸Šã§ã€Œ`Choice.question = models.ForeignKey(Question)`ã€ã‚’å®šç¾©ã™ã‚‹ã¨ã€  
DjangoãŒï¼ˆã€ŒChoiceã¯Questionã¸ã®ForeignKeyãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã€ã®ã§ï¼‰Questionã®å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«Choiceã¸ã¤ãªãŒã‚‹choice_setãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è‡ªå‹•çš„ã«ç”Ÿæˆã™ã‚‹ã€‚

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸURLã‚’å‰Šé™¤

> polls.urlsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®path()é–¢æ•°ã§nameå¼•æ•°ã‚’å®šç¾©ã—ãŸã®ã§ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã®{ï¼…urlï¼…}ã‚’ä½¿ç”¨[...]ã§ãã¾ã™

polls/index.html

```html
<a href="/polls/{{ question.id }}/"></a>
```
â†“
```html
<a href="{% url 'detail' question.id %}"></a>
```

pollsã‚¢ãƒ—ãƒªç”¨ã®URLã€Œ/polls/ã€ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´ã®urls.pyã§è¨­å®šã—ã¦ã„ã‚‹ã‚‚ã®ãªã®ã§ã€ã‚¢ãƒ—ãƒªå´ã§ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ã¨éƒ½åˆãŒæ‚ªã„ã€‚
ã¾ãŸã€è©³ç´°ç”»é¢ã®URLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¤‰ãˆãŸæ™‚ï¼ˆpolls/urls.pyï¼‰ã«ã‚‚ã€é–¢é€£ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’ã™ã¹ã¦ç½®æ›ã—ã¦ã„ã‹ãªã„ã¨ã„ã‘ãªã„ã€‚

å¤‰æ›´å¾Œã§ä½¿ç”¨ã—ã¦ã„ã‚‹`{% url %}`ã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã€Œurlã‚¿ã‚°ã€ã€‚æ›¸å¼ã¯`url <ãƒ“ãƒ¥ãƒ¼> <ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿...>`ã€‚
urls.pyã«è¨˜è¼‰ã•ã‚ŒãŸURLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é€†å¼•ãã—ã¦ã€URLã‚’è¿”ã™ã‚‚ã®ã€‚

`url 'detail'`ã£ã¦æ›¸ãã®ã¯ã„ã„ã‘ã©ã€ã“ã®detailã¯ä½•ã®detailï¼Ÿã¨ã„ã†ç–‘å•ã¸ã®ç­”ãˆã¯æ¬¡ã«ã‚ã£ãŸã€‚

### URLåã®åå‰ç©ºé–“

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«è¤‡æ•°ã®ã‚¢ãƒ—ãƒªãŒã‚ã‚‹å ´åˆã®å¯¾å¿œ

> {% url %}ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã‚’ä½¿ã£ãŸã¨ãã€Djangoã¯ã©ã®ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã—ã¦urlã‚’ä½œæˆã™ã‚Œã°ã„ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
> ç­”ãˆã¯ã€URLconfã«åå‰ç©ºé–“ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã€ã§ã™ã€‚ã©ã†ãpolls/urls.pyãƒ•ã‚¡ã‚¤ãƒ«å†…ã§app_nameã‚’è¿½åŠ ã—[...]ã¦ãã ã•ã„ã€‚

> polls/index.htmlãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’[...]"{% url 'polls:detail' question.id %}"

ã“ã“ã§ãƒ†ãƒ³ãƒ—ãƒ¬å´ã§å­˜åœ¨ã—ãªã„namespaceã‚’æŒ‡å®šã—ãŸã‚‰ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚

```
NoReverseMatch at /polls/
'aaaaa' is not a registered namespace
```

## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®4

> ç°¡å˜ãªãƒ•ã‚©ãƒ¼ãƒ å‡¦ç†ã¨ã‚³ãƒ¼ãƒ‰ã®ç¸®å°åŒ–ã‚’ä¸­å¿ƒã«è§£èª¬ã—ã¾ã™ã€‚

### ç°¡å˜ãªãƒ•ã‚©ãƒ¼ãƒ ã‚’æ›¸ã

> æŠ•ç¥¨è©³ç´°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¦ã€HTMLã®<form>è¦ç´ ã‚’å…¥ã‚Œã¾ã—ã‚‡ã†ã€‚

å›ã‚Šãã©ã„ã‹ã‚‰ç´ ç›´ã«ã€ŒæŠ•ç¥¨ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¾ã—ã‚‡ã†ã€ã¨ã‹æ›¸ã„ã¦ã»ã—ã„ã€‚

æŠ•ç¥¨ãƒšãƒ¼ã‚¸â†’é¸æŠè‚¢ã”ã¨ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¨æŠ•ç¥¨ãƒœã‚¿ãƒ³ã€‚
polls.views.vote()â†’è©²å½“ã®questionãŒæŒã¤ã€POSTã•ã‚ŒãŸchoiceã®votesã«+1ã—ã¦ä¿å­˜ã€‚ãã®å¾Œçµæœãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚
çµæœãƒšãƒ¼ã‚¸â†’å„é¸æŠè‚¢ã«ä½•ç¥¨é›†ã¾ã£ãŸã‹ã‚’è¡¨ç¤ºã€‚

æŠ•ç¥¨æ™‚ã®ç«¶åˆå¯¾ç­–ã¯ã—ã¦ãªã„ã‹ã‚‰æ°—ã‚’ä»˜ã‘ã¦ã­ã€ã¨ã„ã†æ„å‘³ã®æ³¨é‡ˆãŒã‚ã‚‹ã®ã¯è¦ªåˆ‡ã€‚

voteãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã‚Œã€‚saveæ™‚ã«ã¯ã€Œupdate polls_choice set votes = 2 where id = 1ã€ã¿ãŸã„ã«votesã®å€¤ã‚’ç›´æ›¸ãã—ã¦updateã—ã¦ã„ã‚‹ã€‚
```py
selected_choice = question.choice_set.get(pk=request.POST['choice'])
selected_choice.votes += 1
selected_choice.save()
```

ã“ã„ã¤ã‚’ä¿®æ­£ã—ã¦ã€Œupdate polls_choice set votes = votes + 1 where id = 1ã€ã«ã™ã‚‹ãŸã‚ã«ã¯
```py
selected_choice = question.choice_set.get(pk=request.POST['choice'])
selected_choice.votes = F('votes') + 1
selected_choice.save()
```
ã¨ã™ã‚Œã°è‰¯ã„ã‚‰ã—ã„ã€‚F()ã¯Fieldã®Fã€‚
ã“ã‚Œã¯ã“ã‚Œã§èª¤ã£ã¦save()ã‚’2å›æ‰“ã£ã¡ã‚ƒã£ãŸã‚‰ã€Œ+1ã€ãŒ2å›èµ°ã‚‹ã“ã¨ã«ãªã‚‹ã£ã½ã„ã‘ã©ã€ãã‚“ãªã®ã¯ãŸã ã®ãƒã‚°ã ã‹ã‚‰ã„ã„ã‹ã€‚ã€‚ã€‚

### æ±ç”¨ãƒ“ãƒ¥ãƒ¼ã‚’ä½¿ã†: ã‚³ãƒ¼ãƒ‰ãŒå°‘ãªã„ã®ã¯ã„ã„ã“ã¨ã 

> ï¼ˆç°¡å˜ã‹ã¤å†—é•·ãªdetail()ã€results()ã€index()ãƒ“ãƒ¥ãƒ¼ï¼‰ã¯åŸºæœ¬çš„ãª Webé–‹ç™ºã®ä¸€èˆ¬çš„ãªã‚±ãƒ¼ã‚¹ã‚’è¡¨ã—ã¾ã™ã€‚
> ã™ãªã‚ã¡ã€ URL ã‚’ä»‹ã—ã¦æ¸¡ã•ã‚ŒãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¾“ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã€
> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿”ã—ã¾ã™ã€‚
> ã“ã‚Œã¯ãã‚ã‚ã¦ã‚ˆãã‚ã‚‹ã“ã¨ãªã®ã§ã€Djangoã§ã¯ã€æ±ç”¨ãƒ“ãƒ¥ãƒ¼ï¼ˆgeneric viewï¼‰ã¨ã„ã†ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

#### polls/urls.py

before
```py
urlpatterns = [
    path('', views.index, name='index'),
    path('<int:question_id>/', views.detail, name='detail'),
    path('<int:question_id>/results/', views.results, name='results'),
    path('<int:question_id>/vote/', views.vote, name='vote'),
]
```

after
```py
urlpatterns = [
    path('', views.IndexView.as_view(), name='index'),
    path('<int:pk>/', views.DetailView.as_view(), name='detail'),
    path('<int:pk>/results/', views.ResultsView.as_view(), name='results'),
    path('<int:question_id>/vote/', views.vote, name='vote'),
]
```

ç¬¬1å¼•æ•°ã«pkã‚’ä½¿ã†ã‚ˆã†ã«ãªã£ã¦ã€ç¬¬2å¼•æ•°ã«ã¯views.pyã®`ãƒ“ãƒ¥ãƒ¼ã£ã½ã„ã‚¯ãƒ©ã‚¹.as_view()`ã‚’ä½¿ã†ã¨ã€‚
URLè‡ªä½“ã¯å¤‰æ›´ãªã—ã€‚

#### polls/views.py

before
```py
def index(request):
    latest_question_list = Question.objects.order_by('-pub_date')[:5]
    context = {'latest_question_list': latest_question_list}
    return render(request, 'polls/index.html', context)

def detail(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    return render(request, 'polls/detail.html', {'question': question})

def results(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    return render(request, 'polls/results.html', {'question': question})
```

after
```py
from django.views import generic

class IndexView(generic.ListView):
    template_name = 'polls/index.html'
    context_object_name = 'latest_question_list'

    def get_queryset(self):
        """Return the last five published questions."""
        return Question.objects.order_by('-pub_date')[:5]

class DetailView(generic.DetailView):
    model = Question
    template_name = 'polls/detail.html'

class ResultsView(generic.DetailView):
    model = Question
    template_name = 'polls/results.html'
```

ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ã«æŠ•ã’ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹å‡¦ç†ã«ã¯ã€Œ`generic.ãªã‚“ã¡ã‚ƒã‚‰View`ã€ã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ä½¿ã†ã‚“ã ã¨ã€‚  
modelã®æŒ‡å®šã¯å¿…é ˆã€context_object_nameã¨template_nameã¯è¦å®šå€¤ã‹ã‚‰å¤‰ãˆãŸã„ã¨ãã«æŒ‡å®šã™ã‚‹ã€‚  
ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€ã€ŒCSRFã€ã¨ã‹ã€Œã‚¯ãƒ©ã‚¹ã€ã¨ã‹ã®èª¬æ˜ã‚’ã‹ã£é£›ã°ã™ã‹ã‚‰ã‚ã‚‹æ„å‘³æ°—æŒã¡ã„ã„ã­ã€‚


2ã¤ã®DetailViewã«ã¯`model = Question`ã‚’æ¸¡ã—ã¦ã‚‹ã‹ã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ã«ã¯ãã®å®Ÿä½“ã®questionå¤‰æ•°ãŒæ¸¡ã‚‹ã®ã¯ã‚ã‹ã‚‹ã€‚  
ListViewã®`latest_question_list`ã®ä¸­èº«ãŒquestioné…åˆ—ã ã£ã¦ã®ã¯ãªãœã‚ã‹ã‚‹ï¼Ÿ  
get_queryset()ãŒ`return Question.objects`ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã‚‹ã‹ã‚‰ã‹ã€‚  
ï¼ˆQuestion.objectsã ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ã«æ¸¡ã‚‹å¤‰æ•°åã®è¦å®šå€¤ã¯'question_list'ã ã‘ã©ãƒ†ãƒ³ãƒ—ãƒ¬ã§ä½¿ã£ã¦ã‚‹åå‰ã«åˆã‚ã›ã¦å¤‰ãˆã¦ã‚‹ï¼‰  
context_object_name = 'question_list'


## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®5

> Web æŠ•ç¥¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Œæˆã—ãŸã®ã§ã€ä»Šåº¦ã¯è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

å®Œæˆã—ã¦ã„ãŸã‚‰ã—ã„ã€‚

### è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å°å…¥

> Djangoã‚’é–‹ç™ºã—ãŸJacob Kaplan-Mossã¯æ¬¡ã®è¨€è‘‰ã‚’æ®‹ã—ã¦ã„ã¾ã™ã€‚ã€Œãƒ†ã‚¹ãƒˆã®ãªã„ã‚³ãƒ¼ãƒ‰ã¯ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã¨ã—ã¦å£Šã‚Œã¦ã„ã‚‹ã€‚ã€

ã‚°ã‚°ã£ã¦ã‚‚è©³ç´°ã¯è¦‹ã¤ã‹ã‚‰ãšã€‚

> Django ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒã¨ã—ã¦ç”Ÿãã¦ã‚†ãã¤ã‚‚ã‚Šãªã‚‰ã€è‰¯ã„ãƒ†ã‚¹ãƒˆã‚’çµ¶å¯¾ã«æ›¸ã‹ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ï¼

å®Ÿã¯ã¾ã˜ã‚ãªæ–¹ã€…å‘ã‘ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã ã£ãŸã‚‰ã—ã„ã€‚

### åŸºæœ¬çš„ãªãƒ†ã‚¹ãƒˆæ–¹é‡

> ãƒ—ãƒ­ã‚°ãƒ©ãƒã®ä¸­ã«ã¯ã€ã€Œãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºã€ã®åŸå‰‡ã«å¾“ã£ã¦ã„ã‚‹äººãŒã„ã¾ã™ã€‚  
> ãƒ†ã‚¹ãƒˆã®åˆå¿ƒè€…ã®å¤šãã¯ã€å…ˆã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã‹ã‚‰ã€ãã®å¾Œã§ãƒ†ã‚¹ãƒˆãŒå¿…è¦ã ã¨è€ƒãˆã‚‹ã‚‚ã®ã§ã™ã€‚  
> ã‚‚ã—ã™ã§ã«æ•°åƒè¡Œã® Python ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã¨ã—ãŸã‚‰ã€[...]æ¬¡ã«æ–°ã—ã„æ©Ÿèƒ½ã®è¿½åŠ ã‚„ãƒã‚°ã®ä¿®æ­£ã‚’è¡Œã†æ™‚ã«ã€æœ€åˆã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã¿ã‚‹ã¨å½¹ã«ç«‹ã¤ã§ã—ã‚‡ã†ã€‚  

TDDä»¥å¤–ã¯å‰²ã¨å¦å®šã—ã¦ã‚‹æ°—ãŒã™ã‚‹ã€‚

### åˆã‚ã¦ã®ãƒ†ã‚¹ãƒˆä½œæˆ

#### Question.was_published_recently()

> Question.was_published_recently()ã¯[...]ãŒæœªæ¥ã®æ—¥ä»˜ã«ãªã£ã¦ã„ã‚‹å ´åˆã«ã‚‚ True ã‚’è¿”ã—ã¦ã—ã¾ã„ã¾ã™(ä¸é©åˆ‡ãªå‹•ä½œ)ã€‚

`python manage.py shell`ã«ã¦ãƒ†ã‚¹ãƒˆ
```
import datetime
from django.utils import timezone
from polls.models import Question
future_question = Question(pub_date=timezone.now() + datetime.timedelta(days=30))
future_question.was_published_recently()
# => True
```

#### polls/tests.py

```py
import datetime
from django.test import TestCase
from django.utils import timezone
from .models import Question
class QuestionModelTests(TestCase):
    def test_was_published_recently_with_future_question(self):
        """
        was_published_recently() returns False for questions whose pub_date
        is in the future.
        """
        time = timezone.now() + datetime.timedelta(days=30)
        future_question = Question(pub_date=time)
        self.assertIs(future_question.was_published_recently(), False)
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
å¼•æ•°'polls'ã¯çœç•¥å¯ã€‚

```sh
$ docker-compose exec app pipenv run python manage.py test polls
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
F
======================================================================
FAIL: test_was_published_recently_with_future_question (polls.tests.QuestionModelTests)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "/app/polls/tests.py", line 18, in test_was_published_recently_with_future_question
    self.assertIs(future_question.was_published_recently(), False)
AssertionError: True is not False

----------------------------------------------------------------------
Ran 1 test in 0.007s

FAILED (failures=1)
Destroying test database for alias 'default'...
```

> polls ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã«ã‚ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ¢ã—ã¾ã™
> django.test.TestCase ã‚¯ãƒ©ã‚¹ã®ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã‚’ç™ºè¦‹ã—ã¾ã™
> ãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ç‰¹åˆ¥ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™
> ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦ã€test ã§å§‹ã¾ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¢ã—ã¾ã™
> test_was_published_recently_with_future_question ã®ä¸­ã§ã€[...]ä»Šæ—¥ã‹ã‚‰30æ—¥å¾Œã®æ—¥ä»˜ã‚’æŒã¤Questionã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã•ã‚Œã¾ã™
> assertIs() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã†ã“ã¨ã§ã€was_published_recently() ãŒ True ã‚’è¿”ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç™ºè¦‹ã—ã¾ã™
> ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒ test ã§å§‹ã¾ã‚‹åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­ã‹ã‚‰ã€è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆã‚’è¦‹ã¤ã‘ã¦ãã‚Œã¾ã™

æŒ™å‹•ã‹ã‚‰ã®æ¨æ¸¬

- ã€Œtestã§å§‹ã¾ã‚‹åå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€ã®ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¹ãƒšãƒ¼ã‚¹ãŒå«ã¾ã‚Œã¦ã¯ã„ã‘ãªã„ã€‚
- å®Ÿè£…ã™ã‚‹ãƒ†ã‚¹ãƒˆåï¼ˆã‚¯ãƒ©ã‚¹åã€ãƒ¡ã‚½ãƒƒãƒ‰åï¼‰ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«é–“ã§é‡è¤‡ãŒã‚ã£ã¦ã‚‚æ§‹ã‚ãªã„ã€‚
  - tests.pyã‚’ã‚³ãƒ”ãƒ¼ã—ã¦tests copy.pyã‚’ä½œã£ã¦å®Ÿè¡Œã—ã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆçµæœã¯tests.pyã ã‘ã§å®Ÿè¡Œã—ãŸæ™‚ã¨å¤‰ã‚ã‚‰ãšã€‚
  - tests copy.pyã‚’tests_copy.pyã«ãƒªãƒãƒ¼ãƒ ã—ãŸã‚‰ãƒ†ã‚¹ãƒˆãŒ2å›æµã‚ŒãŸã€‚
  - tests_copy.pyå†…ã®QuestionModelTestsã‚¯ãƒ©ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦2ã¤ã«ã—ã¦ã‚‚ã€ãƒ†ã‚¹ãƒˆãŒ2å›æµã‚ŒãŸã€‚

#### ãƒã‚°ã‚’ä¿®æ­£ã™ã‚‹

> models.py ã«ã‚ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£ã—ã¦ã€æ—¥ä»˜ãŒéå»ã ã£ãŸå ´åˆã«ã®ã¿ True ã‚’è¿”ã™ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚

å•ç­”ç„¡ç”¨ã§ä¿®æ­£ã€‚ã€Œrecentlyã€ãŒéå»ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†è¨¼æ‹ ã‚’å¯„ã“ã›ã€ã¨è¨€ã£ã¦ã¯ã„ã‘ãªã„ã‚‰ã—ã„ã€‚

polls/models.py
```py
def was_published_recently(self):
    now = timezone.now()
    return now - datetime.timedelta(days=1) <= self.pub_date <= now
```

ã“ã‚ŒVBAã ã£ãŸã‚‰æ¼”ç®—å­ã€Œ<=ã€ã”ã¨ã«boolå‹ãŒè¿”ã‚‹ã‹ã‚‰ã“ã†ã¯æ›¸ã‘ãªã„ãªãƒ¼ã€‚

```
python: 1 - 2 < 3 < 0 # => False
vba:    1 - 2 < 3 < 0 ' => True
```

ãƒ†ã‚¹ãƒˆã¯OK
```sh
$ docker-compose exec app pipenv run python manage.py test
Creating test database for alias 'default'...
System check identified no issues (0 silenced).
.
----------------------------------------------------------------------
Ran 1 test in 0.003s

OK
Destroying test database for alias 'default'...
```

#### ã‚ˆã‚ŠåŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆ

> Question.was_published_recently() ãŒéå»ã€ç¾åœ¨ã€ãã—ã¦æœªæ¥ã®è³ªå•ã«å¯¾ã—ã¦æ„å‘³ã®ã‚ã‚‹å€¤ã‚’è¿”ã™ã“ã¨ã‚’ç¢ºèªã™ã‚‹3ã¤ã®ãƒ†ã‚¹ãƒˆ

ã‚’ä½œã‚‹ï¼ˆã€Œæœªæ¥ã€ã¯ä½œæˆæ¸ˆã¿ãªã®ã§éå»ã¨ç¾åœ¨ã‚’ä½œã‚‹ï¼‰ã€‚

```py
def test_was_published_recently_with_old_question(self):
    time = timezone.now() - datetime.timedelta(days=1, seconds=1)
    old_question = Question(pub_date=time)
    self.assertIs(old_question.was_published_recently(), False)

def test_was_published_recently_with_recent_question(self):
    time = timezone.now() - datetime.timedelta(hours=23, minutes=59, seconds=59)
    recent_question = Question(pub_date=time)
    self.assertIs(recent_question.was_published_recently(), True)
```

ãƒ†ã‚¹ãƒˆåã¯
`def test_was_published_recentlyã¯pub_dateãŒ1æ—¥ã‚’è¶…ãˆãªã„éå»ã ã¨Trueã‚’è¿”ã™(self)`
ã¨ã—ã¦ã‚‚OKã€‚ãƒ¡ã‚½ãƒƒãƒ‰åã«ã€Œ()ã€ã¨ã€Œã€ã€ãŒä½¿ãˆãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚

### ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

> pub_date ã‚’æœªæ¥ã«è¨­å®šã™ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€ãã® Question ãŒãã®æ—¥ä»˜ã«ãªã£ãŸæ™‚ã«å…¬é–‹ã•ã‚Œã€ãã‚Œã¾ã§ã¯è¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã¯ãšã§ã™ã€‚

ã ã‹ã‚‰ãã®è¨¼æ‹ ã‚’å¯„ã“ï¼ˆï½’ï½™

#### ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆ

> åˆã‚ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ã‚³ãƒ¼ãƒ‰å†…éƒ¨ã®ç´°ã‹ã„å‹•ä½œã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã—ãŸãŒã€
> ã“ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒ Web ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é€šã—ã¦çµŒé¨“ã™ã‚‹å‹•ä½œã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã—ã‚‡ã†ã€‚

#### Django ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

> Django ã¯ã€ãƒ“ãƒ¥ãƒ¼ãƒ¬ãƒ™ãƒ«ã§ã®ãƒ¦ãƒ¼ã‚¶ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ Client ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚
> ã“ã‚Œã‚’ tests.py ã®ä¸­ã‚„ shell ã§ã‚‚ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ã¨ã„ã†ã“ã¨ãªã®ã§å®Ÿè¡Œã€‚

python manage.py shellã‚ˆã‚Š

â€»`setup_test_environment()`ã¨`from django.test import Client`ã¯`python manage.py test`ã§ã¯æ˜ç¤ºä¸è¦ã€‚

```py
from django.test.utils import setup_test_environment
setup_test_environment()
from django.test import Client
client = Client()
# '/'ã¯404ã‚¨ãƒ©ãƒ¼
response = client.get('/')
response.status_code
from django.urls import reverse
# '/polls'ã¯æ­£å¸¸ã«çµæœãŒè¿”ã‚‹
response = client.get(reverse('polls:index'))
response.status_code
response.content
response.context['latest_question_list']
```

#### ãƒ“ãƒ¥ãƒ¼ã‚’æ”¹è‰¯ã™ã‚‹

> ç¾åœ¨ã®æŠ•ç¥¨ã®ãƒªã‚¹ãƒˆã¯ã€ã¾ã å…¬é–‹ã•ã‚Œã¦ã„ãªã„æŠ•ç¥¨ãŒè¡¨ç¤ºã•ã‚Œã‚‹çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‚’ç›´ã—ã¾ã—ã‚‡ã†ã€‚

```py
def get_queryset(self):
    return Question.objects.order_by('-pub_date')[:5]
```

```py
def get_queryset(self):
    return Question.objects.filter(
        pub_date__lte=timezone.now()
    ).order_by('-pub_date')[:5]
```

pub_date__lteã¯ã€pub_date LessThenEqualã€‚
ç¶šãã€Œ=ã€ãŒæ°—æŒã¡æ‚ªã„ã‘ã©ã—ã‚‡ã†ãŒãªã„ã€‚

#### æ–°ã—ã„ãƒ“ãƒ¥ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹

polls/tests.pyã‚’ã”ã¡ã‚ƒã”ã¡ã‚ƒã„ã˜ã‚‹ã€‚

> questionã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆé–¢æ•° create_question[...]ã«ã‚ˆã£ã¦ã€ question ä½œæˆå‡¦ç†ã®ã‚³ãƒ¼ãƒ‰é‡è¤‡ã‚’ãªãã—ã¦ã„ã¾ã™ã€‚

ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã£ã¦è¨€è‘‰å¥½ãã­ã€‚

> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å„ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã§ã€ï¼ˆæ¬¡ã®ãƒ†ã‚¹ãƒˆã§ã¯ï¼‰æœ€åˆã®è³ªå•ã¯æ®‹ã£ã¦ã„ã¾ã›ã‚“ã€‚

> å®Ÿéš›ã®ã¨ã“ã‚ã€ç§ãŸã¡ã¯ãƒ†ã‚¹ãƒˆã‚’ç”¨ã„ã¦ã€ç®¡ç†è€…ã®å…¥åŠ›ã¨ã‚µã‚¤ãƒˆã§ã®ãƒ¦ãƒ¼ã‚¶ã®ä½“é¨“ã«ã¤ã„ã¦ã®ã‚¹ãƒˆãƒ¼ãƒªã‚’èªã‚Šã€
> ã‚·ã‚¹ãƒ†ãƒ ã®å„çŠ¶æ…‹ã¨ãã“ã§ã®æ–°ã—ã„å¤‰åŒ–ã®ãã‚Œãã‚Œã«å¯¾ã—ã¦ã€æœŸå¾…é€šã‚Šã®çµæœãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’
> ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ã®ã§ã™ã€‚


```py
import datetime

from django.test import TestCase
from django.urls import reverse
from django.utils import timezone

from .models import Question

def create_question(question_text, days):
    time = timezone.now() + datetime.timedelta(days=days)
    return Question.objects.create(question_text=question_text, pub_date=time)

class QuestionIndexViewTests(TestCase):
    def test_no_questions(self):
        response = self.client.get(reverse('polls:index'))
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, "No polls are available.")
        self.assertQuerysetEqual(response.context['latest_question_list'], [])

    def test_past_question(self):
        create_question(question_text="Past question.", days=-30)
        response = self.client.get(reverse('polls:index'))
        self.assertQuerysetEqual(
            response.context['latest_question_list'],
            ['<Question: Past question.>']
        )

    def test_future_question(self):
        create_question(question_text="Future question.", days=30)
        response = self.client.get(reverse('polls:index'))
        self.assertContains(response, "No polls are available.")
        self.assertQuerysetEqual(response.context['latest_question_list'], [])

    def test_future_question_and_past_question(self):
        create_question(question_text="Past question.", days=-30)
        create_question(question_text="Future question.", days=30)
        response = self.client.get(reverse('polls:index'))
        self.assertQuerysetEqual(
            response.context['latest_question_list'],
            ['<Question: Past question.>']
        )

    def test_two_past_questions(self):
        create_question(question_text="Past question 1.", days=-30)
        create_question(question_text="Past question 2.", days=-5)
        response = self.client.get(reverse('polls:index'))
        self.assertQuerysetEqual(
            response.context['latest_question_list'],
            ['<Question: Past question 2.>', '<Question: Past question 1.>']
        )

class QuestionModelTests(TestCase):
    # ç•¥
```

#### DetailViewã®ãƒ†ã‚¹ãƒˆ

> æœªæ¥ã®è³ªå•ã¯ index ã«è¡¨ç¤ºã•ã‚Œãªã„ã‚‚ã®ã®ã€
> æ­£ã—ã„URL ã‚’çŸ¥ã£ã¦ã„ãŸã‚Šæ¨æ¸¬ã—ãŸã‚Šã—ãŸãƒ¦ãƒ¼ã‚¶ã¯ã€
> ã¾ã ãƒšãƒ¼ã‚¸ã«åˆ°é”ã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

ã¨è¨€ã„ãªãŒã‚‰ã•ã£ã•ã¨`views.py`ã‚’ä¿®æ­£ã—ã¦ã€ãã®å¾Œtestsã‚’å®Ÿè£…ã™ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‹ã£ã“ã„ã„ã€‚

ã¨ã‚Šã‚ãˆãšå…ˆã«ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã¨ã€ç¾çŠ¶ã§ã¯ã“ã®ãƒ†ã‚¹ãƒˆã®çµæœãŒ`AssertionError: 200 != 404`ã ã‹ã‚‰ã€ç¢ºã‹ã«è¦ä¿®æ­£ã ã­ã€ã¨ã€‚

ã‚ã¨ãƒ†ã‚¹ãƒˆå†…ã§`print(response)`ã‚’æ›¸ã„ãŸã‚‰ã¡ã‚ƒã‚“ã¨`<TemplateResponse status_code=200, "text/html; charset=utf-8">`ãŒå‡ºåŠ›ã•ã‚ŒãŸã€‚

```py
class QuestionDetailViewTests(TestCase):
    # æœªæ¥æ—¥ä»˜ã®questionã¸ã®è©³ç´°ãƒšãƒ¼ã‚¸ã«è¡Œã‘ã¡ã‚ƒã†ã¨NGã€‚
    def test_future_question(self):
        future_question = create_question(question_text='Future question.', days=5)
        url = reverse('polls:detail', args=(future_question.id,))
        response = self.client.get(url)
        self.assertEqual(response.status_code, 404)
```

#### ã•ã‚‰ãªã‚‹ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦è€ƒãˆã‚‹

> ï¼ˆIndexViewã€DetailViewã«åŠ ãˆã¦ï¼‰ResultsView ã«ã‚‚åŒã˜ã‚ˆã†ã« get_queryset ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ã€
> ãƒ†ã‚¹ãƒˆã¯é‡è¤‡ã ã‚‰ã‘ã«ãªã‚‹ã¯ãšã§ã™ã€‚
> ã‚ã‚‹æ™‚ç‚¹ã§ã€[...]ãƒ†ã‚¹ãƒˆãŒè†¨ã‚‰ã¿ã™ãã¦ã‚³ãƒ¼ãƒ‰ãŒè‹¦ã—ããªã£ã¦ã—ã¾ã†ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ç–‘å•ãŒæµ®ã‹ã‚“ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚
> ã“ã†ãªã£ãŸå ´åˆã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

### ãƒ†ã‚¹ãƒˆã«ãŠã„ã¦ã€å¤šã„ã“ã¨ã¯ã„ã„ã“ã¨ã 

> æ§‹ã„ã¾ã›ã‚“ã€‚ã‚ãªãŸã¯ãƒ†ã‚¹ãƒˆã‚’ä¸€å›æ›¸ã„ãŸã‚‰ã€ãã®ã“ã¨ã‚’å¿˜ã‚Œã¦å¤§ä¸ˆå¤«ã§ã™ã€‚
> ãƒ†ã‚¹ãƒˆã«ãŠã„ã¦ã¯ã€å†—é•·ã§ã‚ã‚‹ã“ã¨ã¯è‰¯ã„ã“ã¨ãªã®ã§ã™ã€‚

> çµŒé¨“ä¸Šã€è‰¯ã„ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦æ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚
> ãƒ¢ãƒ‡ãƒ«ã‚„ãƒ“ãƒ¥ãƒ¼ã”ã¨ã« TestClass ã‚’åˆ†å‰²ã™ã‚‹
> ãƒ†ã‚¹ãƒˆã—ãŸã„æ¡ä»¶ã®é›†ã¾ã‚Šã®ãã‚Œãã‚Œã«å¯¾ã—ã¦ã€ç•°ãªã‚‹ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚‹
> ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®åå‰ã¯ã€ãã®æ©Ÿèƒ½ã‚’èª¬æ˜ã™ã‚‹ã‚ˆã†ãªã‚‚ã®ã«ã™ã‚‹

ã“ã‚Œã¯ã‚‚ã†å®Ÿç¾ã•ã‚Œã¦ã‚‹ã‚ˆã­ã€‚

### ã•ã‚‰ãªã‚‹ãƒ†ã‚¹ãƒˆ

> Django ã«ã¯ã€Selenium ã®ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã¨ã®é€£æºã‚’å®¹æ˜“ã«ã—ã¦ãã‚Œã‚‹
> LiveServerTestCase ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä½¿ã£ã¦ã¿ãŸã€‚
ãƒ†ã‚¹ãƒˆã®ä¸­ã§tryï½exceptã‚’ä½¿ã£ã¦ã‚¨ãƒ©ãƒ¼ã‚’æ¡ã‚Šã¤ã¶ã™ã¨ã€ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¦ã‚‚OKã«ãªã‚‹ã“ã¨ãŒåˆ†ã‹ã£ãŸã€‚

## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®6

> é™çš„ (static) ãƒ•ã‚¡ã‚¤ãƒ«
> django.contrib.staticfiles ã¯[...]é™çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰
> ä¸€ã¤ã®å ´æ‰€ã«é›†ã‚ã€é‹ç”¨ç’°å¢ƒã§å…¬é–‹ã—ã‚„ã™ãã™ã‚‹ã‚‚ã®ã§ã™ã€‚

### ã‚¢ãƒ—ãƒª ã®æ§‹é€ ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹

#### CSSã®ä½œæˆ

<https://docs.djangoproject.com/ja/2.2/ref/settings/#std:setting-STATICFILES_FINDERS>
`mkdir polls\static\polls`â†’`code polls/static/polls/style.css`ã§é©å½“ã«ä½œã‚‹ã¨
ã€Œå„ã‚¢ãƒ—ãƒªå†…ã®staticãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™ã€ä»•çµ„ã¿ã«ã‚ˆã£ã¦ã€ä»Šä½œã£ãŸCSSãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæ§˜ã«ã€polls ã¨ã„ã†åˆ¥ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œã‚‰ãšã«ã€ç›´æ¥ polls/static ã®ä¸­ã«
> é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦ã‚‚ã„ã„ã®ã§ã¯ãªã„ã‹ã€ã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚ã—ã‹ã—ã€ãã‚Œã¯å®Ÿéš›ã«ã¯æ‚ªã„è€ƒãˆã§ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæ§˜ã«"namespace"ã‚’åˆ‡ã£ã¦ã‚„ã‚‹ã€‚

ãƒ†ãƒ³ãƒ—ãƒ¬ã®å…ˆé ­ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ã€ã‚µãƒ¼ãƒã‚’å†èµ·å‹•ã™ã‚‹ã¨ã€{% static %}ã‚¿ã‚°ãŒCSSã®URL`/static/polls/style.css`ã«ç½®ãæ›ã‚ã£ã¦ã„ã‚‹ã€‚

```html
{% load static %}

<link rel="stylesheet" type="text/css" href="{% static 'polls/style.css' %}">
```

### èƒŒæ™¯ç”»åƒã‚’è¿½åŠ ã™ã‚‹

ç”»åƒã¯ 'mkdir polls\static\polls\images'ã®ä¸­ï¼ˆ'polls/static/polls/images/background.gif'ï¼‰ã«é…ç½®ã™ã‚‹ã€‚
ãã®å¾Œã§CSSã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ãƒªãƒ­ãƒ¼ãƒ‰ã€‚

```css
body {
    background: white url("images/background.png") no-repeat;
}
```

ç”»åƒã¯é©å½“ã«ã¨ã£ã¦ãã‚‹

```sh
curl -o polls/static/polls/images/background.png https://3.bp.blogspot.com/-Peo7_ElXhxU/VD3R2oUl25I/AAAAAAAAoJ4/j5QFdoEKTD8/s800/akichi.png
```

## ã¯ã˜ã‚ã¦ã®Djangoã‚¢ãƒ—ãƒªä½œæˆã€ãã®7

> DjangoãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹ç®¡ç†ã‚µã‚¤ãƒˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã«ç„¦ç‚¹ã‚’å½“ã¦ã¾ã™ã€‚

### adminãƒ•ã‚©ãƒ¼ãƒ ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

> admin ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºæ–¹æ³•ã‚„æ“ä½œã®ä»•æ–¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‹ã‚‰å¤‰æ›´ã—ãŸã„ã“ã¨ã‚‚ã‚ˆãã‚ã‚Šã¾ã™ã€‚
> ãã‚Œã«ã¯ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç™»éŒ²ã™ã‚‹æ™‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚

å„ã‚¢ãƒ—ãƒªã®admin.pyã«ã¦ã€`admin.site.register()`ã®ç¬¬2å¼•æ•°ã«ã€Œãƒ¢ãƒ‡ãƒ«ã”ã¨ã®ModelAdminã‚¯ãƒ©ã‚¹ã€ã‚’ç™»éŒ²ã™ã‚‹ã€‚
ã“ã“ã§ã¯ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã§ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºé †ã‚’å¤‰ãˆã¦ã„ã‚‹ã€‚

admin.py
```py
from django.contrib import admin

from .models import Question

class QuestionAdmin(admin.ModelAdmin):
    fields = ['pub_date', 'question_text']

admin.site.register(Question, QuestionAdmin)
```

> ã¾ãŸã€æ•°åã‚‚ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚»ãƒƒãƒˆã«åˆ†å‰²ã—ãŸã„ã“ã¨ã‚‚ã‚ã‚‹ã§ã—ã‚‡ã†ã€‚

ã€Œãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚»ãƒƒãƒˆã«åˆ†å‰²ã€ã£ã¦è¨€ã‚ã‚Œã¦ã‚‚æ­£ç›´ãƒ”ãƒ³ã¨ã“ãªã‹ã£ãŸã‚ˆã€‚ã€‚

ã“ã‚Œã§æŒ‡å®šã—ãŸ`fields`ã”ã¨ã«[`<fieldset>`](http://www.htmq.com/html5/fieldset.shtml)ã§å›²ã¾ã‚Œã‚‹ã€‚

polls/admin.py
```py
class QuestionAdmin(admin.ModelAdmin):
    fieldsets = [
        (None,               {'fields': ['question_text']}),
        ('Date information', {'fields': ['pub_date']}),
    ]

admin.site.register(Question, QuestionAdmin)
```

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¼µã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è¿½åŠ 

> Question ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã¯ã§ãã¾ã—ãŸã€‚ã—ã‹ã— Question ã¯è¤‡æ•°ã® Choice ã‚’æŒã¤ã®ã«ã€ç®¡ç†ãƒšãƒ¼ã‚¸ã«ã¯è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã­ã€‚

> ä¸€ã¤ç›®ã¯ã€ Question ã¨åŒæ§˜ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ Choice ãƒ¢ãƒ‡ãƒ«ã‚’ç®¡ç†ã‚µã‚¤ãƒˆã«ç™»éŒ²ã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ã“ã‚Œã§ã‚‚çµæ§‹ä¾¿åˆ©ã€‚Questionã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§é¸ã¹ã‚‹ã—ã€ãã®æ¨ªã®addãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€Œquestionã‚’è¿½åŠ ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ãã—ã€‚

polls/admin.py
```py
from .models import Choice, Question
admin.site.register(Choice)
```

> ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã¯ Choice ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚·ã‚¹ãƒ†ãƒ ã«è¿½åŠ ã™ã‚‹ã«ã¯åŠ¹ç‡çš„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
> Question ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã™ã‚‹æ™‚ã« Choice ã‚’ã²ã¨æƒã„è¿½åŠ ã§ããŸæ–¹ãŒä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚ãã†ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
> Choice ãƒ¢ãƒ‡ãƒ«ã«å¯¾ã™ã‚‹ register() ã‚’å‰Šé™¤ã—ã¦ã€ Question ã®ç™»éŒ²ã™ã‚‹éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ã€‚

polls/admin.py

```py
from django.contrib import admin
from .models import Choice, Question

class ChoiceInline(admin.StackedInline):
    model = Choice
    extra = 3

class QuestionAdmin(admin.ModelAdmin):
    fieldsets = [
        (None,               {'fields': ['question_text']}),
        ('Date information', {'fields': ['pub_date'], 'classes': ['collapse']}),
    ]
    inlines = [ChoiceInline]

admin.site.register(Question, QuestionAdmin)
```

Choiceã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯Questionã®ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰ç·¨é›†ã™ã‚‹ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€è¿½åŠ 3ã¤åˆ†ã®Choiceã‚’è¡¨ç¤ºã™ã‚‹æ ã‚’ç”¨æ„ã™ã‚‹ã€‚
ChoiceInlineã‚¯ãƒ©ã‚¹ã«ã‚ˆã£ã¦ã€ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¡¨ç¤ºæ–¹æ³•ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã€‚  
[è¦å®šã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•](https://docs.djangoproject.com/ja/2.1/ref/contrib/admin/#inlinemodeladmin-objects)ã¯2é€šã‚Š  
TabularInlineã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¨ªã«ä¸¦ã¹ã¦ã„ãè¡¨å½¢å¼  
StackedInlineã¯ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¸‹ã«ç©ã¿ä¸Šã’ã¦ã„ãæ–¹å¼

### ç®¡ç†ã‚µã‚¤ãƒˆã®ãƒã‚§ãƒ³ã‚¸ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹

> ä»Šåº¦ã¯ã€Œãƒã‚§ãƒ³ã‚¸ãƒªã‚¹ãƒˆã€ãƒšãƒ¼ã‚¸ã‚’ã™ã“ã—ã„ã˜ã‚Šã¾ã—ã‚‡ã†ã€‚ãƒã‚§ãƒ³ã‚¸ãƒªã‚¹ãƒˆ (change list) ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®å…¨ã¦ã® Question ã‚’è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ã§ã™ã€‚

ã€Œadmin/polls/question/ã€ã®ã“ã¨ã€‚ã€ŒSelect question to changeã€ç”»é¢ã€‚  
ã“ã“ã«æƒ…å ±ï¼ˆ`pub_date`ã®è¡¨ç¤ºã¨ã‹ï¼‰ã‚’è¿½åŠ ã—ã¦ã„ãã€‚

> å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’è¡¨ç¤ºã•ã›ã‚‹ã«ã¯ã€list_displayã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚

å…ƒã€…QUESTIONåˆ—ï¼ˆå€¤ã¯å„questionã®`_str_`ï¼‰1åˆ—ã ã‘ã ã£ãŸãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’ã€  
QUESTION TEXTã€DATE PUBLISHEDã€WAS PUBLISHED RECENTLYã®3åˆ—ã«ã™ã‚‹ã€‚

polls/admin.py

```py
class QuestionAdmin(admin.ModelAdmin):
    # ...
    list_display = ('question_text', 'pub_date', 'was_published_recently')
```

> was_published_recentlyãƒ˜ãƒƒãƒ€ã¯[...]ä¸¦ã¹æ›ãˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„

ã®ã§ã€modelã‚’ã„ã˜ã£ã¦æ”¹å–„ã™ã‚‹ã€‚

polls/models.py
```py
class Question(models.Model):
    # ...
    def was_published_recently(self):
        now = timezone.now()
        return now - datetime.timedelta(days=1) <= self.pub_date <= now
    was_published_recently.admin_order_field = 'pub_date'
    was_published_recently.boolean = True
    was_published_recently.short_description = 'Published recently?'
```

was_published_recently()ã®å®šç¾©ã¯ãã®ã¾ã¾ã§ã€ã“ã®é–¢æ•°ã®admin_order_fieldã€booleanã€short_descriptionãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã„ã˜ã£ã¦ã„ã‚‹ã€‚

ã“ã‚Œã«ã‚ˆã£ã¦ã€QuestionAdminã§å®šç¾©ã—ãŸ[list_display](https://docs.djangoproject.com/ja/2.2/ref/contrib/admin/#django.contrib.admin.ModelAdmin.list_display)ãŒã€was_published_recentlyãŒã©ã®ã‚ˆã†ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã®ã‹ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

`admin_order_field = 'pub_date'`ï¼šorder by pub_dateã§ã‚½ãƒ¼ãƒˆã§ãã‚‹ï¼ˆæœªæŒ‡å®šã ã¨SQLã®order byå¥ãŒä½¿ãˆãªã„ã¨åˆ¤æ–­ã•ã‚Œã¦ã‚½ãƒ¼ãƒˆå¯èƒ½åˆ—ã«ãªã‚‰ãªã„ï¼‰ã€‚
`boolean = True`ï¼šboolå‹ãªã®ã§ã€UIä¸Šã¯OXã®ã‚¢ã‚¤ã‚³ãƒ³ã§è¡¨ã›ã°ã‚ˆã„ï¼ˆæœªæŒ‡å®šã ã¨æˆ»ã‚Šå€¤ã®_str_è¡¨ç¾='True''False'ã¨ã„ã†æ–‡å­—åˆ—ãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ã€‚
`short_description = 'Published recently?'`ï¼šåˆ—åã¯'Published recently?'ã¨ã™ã‚‹ï¼ˆæœªæŒ‡å®šã ã¨é–¢æ•°åã®human readableè¡¨ç¾ã«ãªã‚‹ï¼‰ã€‚

> ãƒã‚§ãƒ³ã‚¸ãƒªã‚¹ãƒˆã‚’pub_dateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã«å¾“ã£ã¦ãƒ•ã‚£ãƒ«ã‚¿ã§ãã‚‹ã‚ˆã†ã«

ã™ã‚‹ãŸã‚ã«ã€Questionã®ãƒã‚§ãƒ³ã‚¸ãƒªã‚¹ãƒˆã®ãƒšãƒ¼ã‚¸ï¼ˆpolls/admin.pyï¼‰ã« list_filter ã‚’è¿½åŠ ã™ã‚‹

polls/admin.py
```py
class QuestionAdmin(admin.ModelAdmin):
    # ...
    list_filter = ['pub_date']
```

> æ¤œç´¢æ©Ÿèƒ½ã‚’è¿½åŠ 

ã™ã‚‹ãŸã‚ã«ã¯search_fieldsã‚’è¿½åŠ ã€‚å†…éƒ¨çš„ã«ã¯SQLã®likeå¥ã€‚

```py
search_fields = ['question_text']
```

### ç®¡ç†ã‚µã‚¤ãƒˆã®ãƒ«ãƒƒã‚¯ & ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹

ç®¡ç†ãƒšãƒ¼ã‚¸ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¤‰ãˆã‚‹ã€‚

#### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒ ã™ã‚‹ã€‚

> Django è‡ªä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å†…ã«ã‚ã‚‹ã€[...]admin/base_site.html ã¨ã„ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã€æ–°ã—ãä½œã£ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

ãˆãƒ¼ã¨ã€

```sh
docker-compose exec app pipenv run python -c "import django; print(django.__path__)"
# => ['/app/.venv/lib/python3.7/site-packages/django']
docker cp try_django_app_1:/app/.venv/lib/python3.7/site-packages/django/contrib/admin/templates/admin/base_site.html ./templates/admin/base_site.html
```

ã§ã€ãã®ä¸­ã®<h1>ã‚¿ã‚°å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€ŒPolls Administrationã€ã«å¤‰ãˆã‚‹ã€‚
titleã‚’å¤‰ãˆã‚‹ã¨ã€å…ˆã«ä½œæˆã—ã¦ã„ãŸseleniumãƒ†ã‚¹ãƒˆãŒä¸€éƒ¨å£Šã‚Œã‚‹ã‹ã‚‰ä¿®æ­£ï¼ˆ`self.assertTrue(self.browser.title != '')`ã ã‘ã§ã„ã„ã‚„ï¼‰ã€‚

```
- ãƒ­ã‚°ã‚¤ãƒ³ | Polls Administration
+ ãƒ­ã‚°ã‚¤ãƒ³ | Django ã‚µã‚¤ãƒˆç®¡ç†
```
